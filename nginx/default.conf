# =========================
# SERVEUR HTTP (port 80)
# =========================
server {                                  # Déclare un serveur virtuel Nginx (HTTP)

    listen 80;                             # Nginx écoute sur le port HTTP 80
    server_name restrospectivestudio.fr www.restrospectivestudio.fr;
                                           # Domaines acceptés (racine + www)

    # Route spéciale utilisée par Let's Encrypt pour vérifier que
    # le serveur contrôle bien le domaine (challenge HTTP-01)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;             # Dossier partagé avec le container certbot
    }

    # Toutes les autres requêtes HTTP
    location / {
        return 301 https://$host$request_uri;
                                           # Redirection permanente HTTP → HTTPS
    }
}

# =========================
# SERVEUR HTTPS (port 443)
# =========================
server {                                  # Déclare un serveur virtuel HTTPS

    listen 443 ssl;                        # Nginx écoute sur le port HTTPS 443
    server_name restrospectivestudio.fr www.restrospectivestudio.fr;
                                           # Domaines sécurisés par TLS

    ssl_certificate     /etc/letsencrypt/live/restrospectivestudio.fr/fullchain.pem;
                                           # Certificat TLS Let's Encrypt
    ssl_certificate_key /etc/letsencrypt/live/restrospectivestudio.fr/privkey.pem;
                                           # Clé privée TLS

    ssl_protocols TLSv1.2 TLSv1.3;          # Protocoles TLS autorisés (sécurisés)

    root /var/www/html;                    # Dossier racine WordPress
    index index.php index.html;            # Fichiers d’index par défaut

    # =========================
    # WORDPRESS
    # =========================
    location / {                           # Route principale du site
        try_files $uri $uri/ /index.php?$args;
                                           # Réécriture WordPress standard
    }

    # =========================
    # PHP (PHP-FPM)
    # =========================
    location ~ \.php$ {                    # Toutes les requêtes se terminant par .php
        include fastcgi_params;            # Paramètres FastCGI standards
        fastcgi_pass cloud1-wordpress:9000;
                                           # Envoie l'exécution PHP au container WordPress
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                                           # Chemin du fichier PHP exécuté
    }

    # =========================
    # PHPMYADMIN
    # =========================
    location /phpmyadmin {                 # URL pour accéder à phpMyAdmin
        proxy_pass http://cloud1-phpmyadmin:80;
                                           # Redirection vers le container phpMyAdmin
        proxy_set_header Host $host;        # Conserve le Host original
        proxy_set_header X-Real-IP $remote_addr;
                                           # Transmet l’IP réelle du client
    }
}
